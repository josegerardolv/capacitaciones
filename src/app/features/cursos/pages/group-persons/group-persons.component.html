<div class="min-h-screen">

    <!-- Tarjeta superior: título y breadcrumb -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }"
        class="mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-institucional-primario bg-opacity-10 flex items-center justify-center">
                <app-universal-icon name="person_text" type="material" class="w-6 h-6 text-white"></app-universal-icon>
            </div>

            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Personas inscritas {{ 'al grupo ' +
                    (this.groupLabel ? (this.groupLabel || 'id' + this.groupId) : '')}}</h1>
                <p class="text-sm text-gray-500 mt-1">Gestiona las personas del grupo</p>
            </div>
        </div>

        <div class="mt-2 ml-4">
            <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
    </app-institutional-card>
    <br>

    <!-- Tarjeta inferior: acciones, tabla y paginación -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }">
        <!-- Toolbar: paginación superior y botón crear -->
        <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-center gap-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="true"
                [showPaginationControls]="false" (pageChange)="onPageChange($event)">
            </app-table-pagination>

            <app-institutional-button (buttonClick)="openNewPersonForm()" [config]="{
                    variant: 'primary',
                    icon: 'add',
                    title: 'Nueva Persona'
                }">
                Nueva Persona
            </app-institutional-button>
        </div>

        <!-- Search Bar -->
        <app-table-filters [showGlobalSearch]="true" [globalSearchPlaceholder]="'Buscar por nombre, licencia, CURP...'"
            (globalSearchChange)="filterData($event)">
        </app-table-filters>

        <!-- Tabla -->
        <app-institutional-table [data]="persons" [columns]="tableColumns" [config]="tableConfig">
        </app-institutional-table>

        <!-- Paginación inferior -->
        <div class="mt-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="false"
                [showPaginationControls]="true" (pageChange)="onPageChange($event)">
            </app-table-pagination>
        </div>

    </app-institutional-card>

    <!-- MODAL DE BÚSQUEDA (NUEVO REUTILIZABLE) -->
    <app-license-search-modal [isOpen]="isSearchModalOpen" (modalClose)="isSearchModalOpen = false"
        (personFound)="onPersonFound($event)" (manualRegistration)="onManualRegistration($event)">
    </app-license-search-modal>

    <!-- Templates -->
    <!-- Nombre Completo: Combina Nombre + Apellidos -->
    <ng-template #nameTemplate let-item>
        <div class="flex flex-col">
            <span class="font-bold text-gray-900">{{ item.name }} {{ item.paternal_lastName }} {{ item.maternal_lastName
                }}</span>
        </div>
    </ng-template>

    <!-- Estatus: Badge Aprobado/No Aprobado o Botones de Calificación -->
    <ng-template #statusTemplate let-item>
        <!-- Estado ya calificado: usar badge institucional -->
        <ng-container *ngIf="item.status !== 'Pendiente'">
            <app-institutional-badge
                [config]="{ variant: item.status === 'Aprobado' ? 'success' : 'danger', size: 'small' }">
                {{ item.status }}
            </app-institutional-badge>
        </ng-container>

        <!-- Pendiente: acciones de calificación con botones institucionales -->
        <div *ngIf="item.status === 'Pendiente'" class="flex items-center justify-center gap-2">
            <app-institutional-button
                [config]="{ variant: 'success', icon: 'check', iconPosition: 'only', title: 'Aprobar',size: 'small' }"
                (buttonClick)="setExamResult(item, 'Aprobado')" [appTooltip]="'Aprobar Examen'" tooltipPosition="top">
            </app-institutional-button>

            <app-institutional-button
                [config]="{ variant: 'danger', icon: 'close', iconPosition: 'only', title: 'Reprobar', size: 'small' }"
                (buttonClick)="setExamResult(item, 'No Aprobado')" [appTooltip]="'Reprobar Examen'"
                tooltipPosition="top">
            </app-institutional-button>
        </div>
    </ng-template>
    <!-- Acciones: Botones circulares de colores -->
    <!-- Acciones: Botones circulares -->
    <ng-template #actionsTemplate let-item>
        <div class="flex items-center justify-center gap-2">
            <!-- Ver Constancias (Unificado) -->
            <app-institutional-button [config]="{
                    variant: 'success',
                    icon: 'description',
                    iconPosition: 'only',
                    title: 'Ver Constancias y Pagos',
                    disabled: item.status !== 'Aprobado'
                }" (buttonClick)="item.status === 'Aprobado' && openDocumentsModal(item)"
                [appTooltip]="item.status === 'Aprobado' ? 'Ver Constancias y Pagos' : 'Requiere Aprobación'"
                tooltipPosition="top">
            </app-institutional-button>

            <!-- Eliminar (Rojo) -->
            <app-institutional-button [config]="{
                    variant: 'danger',
                    icon: 'delete',
                    iconPosition: 'only',
                    title: 'Eliminar'
                }" (buttonClick)="deletePerson(item)" [appTooltip]="'Eliminar Persona'" tooltipPosition="top">
            </app-institutional-button>
        </div>
    </ng-template>

    <!-- Modales Genéricos -->
    <app-confirmation-modal [isOpen]="isConfirmOpen" [config]="confirmConfig" (confirm)="onConfirmYes()"
        (cancel)="isConfirmOpen = false" (modalClose)="isConfirmOpen = false">
    </app-confirmation-modal>

    <app-alert-modal [isOpen]="isAlertOpen" [config]="alertConfig" (actionClick)="isAlertOpen = false"
        (modalClose)="isAlertOpen = false">
    </app-alert-modal>

    <!-- Modal de Gestión de Documentos (NUEVO) -->
    <app-documents-modal [isOpen]="isDocumentsModalOpen" [person]="selectedPersonForDocs"
        [courseTypeId]="currentGroup?.courseTypeId || null" (onClose)="closeDocumentsModal()">
    </app-documents-modal>
</div>