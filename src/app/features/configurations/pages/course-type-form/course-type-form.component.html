<div class="min-h-screen">
    <!-- Header Card -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }"
        class="mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-institucional-primario bg-opacity-10 flex items-center justify-center">
                <app-universal-icon name="edit_note" type="material" class="w-6 h-6 text-white"></app-universal-icon>
            </div>

            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">{{ isEditMode ? 'Editar Tipo de Curso' :
                    'Nuevo Tipo de Curso' }}</h1>
                <p class="text-sm text-gray-500 mt-1">Configura los datos del curso, campos de registro y documentos
                    asociados.</p>
            </div>
        </div>

        <div class="mt-2 ml-4">
            <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
    </app-institutional-card>

    <br>

    <form [formGroup]="form" class="space-y-6">

        <!-- Split Layout: Basic Info (Left) & Fields (Right) -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- Left Side: Basic Info -->
            <app-institutional-card class="h-full block lg:col-span-2"
                [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true, customClass: 'h-full !overflow-visible' }">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">DATOS TIPO CURSO</h3>
                <div class="space-y-3">
                    <app-input-enhanced controlName="name" [control]="form.get('name')" label="Nombre del tipo de curso"
                        placeholder="Ingresa el nombre del tipo de curso" [required]="true" size="sm">
                    </app-input-enhanced>
                    <br>
                    <app-input-enhanced controlName="description" [control]="form.get('description')"
                        label="Descripción del tipo de curso" placeholder="Ingresa la descripción del tipo de curso"
                        [required]="true" size="sm">
                    </app-input-enhanced>
                    <br>
                    <div class="relative">
                        <app-input-enhanced controlName="type" [control]="typeControl" label="Tipo de curso"
                            placeholder="Escribe para buscar..." [required]="true" size="sm" [autocomplete]="'off'"
                            (focus)="onTypeFocus()" (blur)="onTypeBlur()" (inputEvent)="handleTypeInput($event)">
                        </app-input-enhanced>

                        <!-- Dropdown List -->
                        <ul *ngIf="showTypeDropdown && filteredTypeOptions.length > 0"
                            class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto focus:outline-none">
                            <li *ngFor="let option of filteredTypeOptions" (click)="selectType(option)"
                                class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors border-b border-gray-100 last:border-0">
                                {{ option.label }}
                            </li>
                        </ul>

                        <!-- No results -->
                        <div *ngIf="showTypeDropdown && filteredTypeOptions.length === 0"
                            class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg px-4 py-3 text-sm text-gray-500 text-center">
                            No se encontraron coincidencias.
                        </div>
                    </div>
                </div>
            </app-institutional-card>

            <!-- Right Side: Fields Selection -->
            <app-institutional-card class="h-full block lg:col-span-3"
                [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true, customClass: 'h-full contents-flex' }">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">SELECCIONE LOS CAMPOS</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                    <ng-container *ngFor="let field of registrationFields">
                        <div
                            class="flex items-center justify-between py-2 px-3 border rounded-md bg-white border-gray-100 hover:border-gray-200 transition-colors h-14">

                            <!-- Left: Checkbox & Label (Controls Visibility) -->
                            <div class="flex items-center gap-3" [ngClass]="{'opacity-50': isVisibilityLocked(field)}"
                                (click)="!isVisibilityLocked(field) && toggleField(field)">

                                <div class="relative flex items-center justify-center h-5 w-5">
                                    <input type="checkbox" [checked]="field.visible"
                                        [disabled]="isVisibilityLocked(field)"
                                        class="h-5 w-5 text-[#8B1538] border-gray-300 rounded focus:ring-[#8B1538] transition-all"
                                        [ngClass]="{'cursor-pointer': !isVisibilityLocked(field), 'cursor-not-allowed': isVisibilityLocked(field)}">
                                </div>
                                <span class="text-sm font-medium text-gray-700 select-none cursor-pointer"
                                    [ngClass]="{'cursor-not-allowed': isVisibilityLocked(field)}"
                                    title="{{field.label}}">
                                    {{ field.label }}
                                </span>
                            </div>

                            <!-- Right: Toggle Switch (Controls Required) -->
                            <div class="flex flex-col items-end gap-1">
                                <span
                                    class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider select-none leading-none">
                                    {{ field.required ? 'Obligatorio' : 'Opcional' }}
                                </span>

                                <!-- Toggle UI -->
                                <button type="button" (click)="field.visible && toggleRequired(field, $event)"
                                    [disabled]="!field.visible || isRequirementLocked(field)"
                                    class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none"
                                    [ngClass]="{
                                            'bg-[#8B1538]': field.visible && field.required, 
                                            'bg-gray-200': !field.visible || !field.required,
                                            'opacity-50 cursor-not-allowed': !field.visible || isRequirementLocked(field)
                                        }" role="switch" [attr.aria-checked]="field.required">

                                    <span aria-hidden="true"
                                        class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                        [ngClass]="{'translate-x-4': field.visible && field.required, 'translate-x-0': !field.visible || !field.required}">
                                    </span>
                                </button>
                            </div>

                        </div>
                    </ng-container>
                </div>
            </app-institutional-card>
        </div>

        <!-- Template Selection Section -->
        <app-institutional-card
            [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: false }">
            <div class="flex flex-col-reverse md:flex-row md:items-center justify-between gap-4 mb-4">

                <!-- Page Size Selector -->
                <div class="flex items-center">
                    <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="true"
                        [showPaginationControls]="false" (pageChange)="onPageChange($event)">
                    </app-table-pagination>
                </div>

                <!-- Search -->
                <div class="w-full md:w-auto min-w-[300px]">
                    <app-table-filters [showGlobalSearch]="true" [globalSearchPlaceholder]="'Buscar Template...'"
                        (globalSearchChange)="filterTemplates($event)">
                    </app-table-filters>
                </div>
            </div>

            <!-- Table -->
            <div class="border rounded-lg overflow-hidden border-gray-200">
                <app-institutional-table [data]="displayedTemplates" [columns]="tableColumns" [config]="tableConfig"
                    [selectedItems]="selectedTemplates" (selectionChange)="onSelectionChange($event)">

                    <!-- Custom Actions Template -->
                    <ng-template #actionsTemplate let-item>
                        <app-institutional-button [config]="{
                                variant: 'info',
                                size: 'small',
                                icon: 'visibility',
                                iconPosition: 'only',
                                title: 'Ver Vista Previa'
                            }" [appTooltip]="'Ver Vista Previa'" tooltipPosition="top"
                            (buttonClick)="openPreview(item)">
                        </app-institutional-button>
                    </ng-template>

                    <ng-template #costTemplate let-item>
                        <span *ngIf="item.conceptCosto > 0" class="font-medium">{{ item.conceptCosto |
                            currency:'MXN' }}</span>
                        <span *ngIf="item.conceptCosto === 0"
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            Gratuito
                        </span>
                    </ng-template>

                    <ng-template #categoryTemplate let-item>
                        <span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            {{ item.category || 'General' }}
                        </span>
                    </ng-template>

                    <ng-template #mandatoryTemplate let-item>
                        <div class="flex justify-center" (click)="$event.stopPropagation()">
                            <input type="checkbox" [checked]="isMandatory(item.id)"
                                (click)="toggleMandatory(item.id, $event)"
                                class="h-4 w-4 text-[#8B1538] border-gray-300 rounded focus:ring-[#8B1538] cursor-pointer"
                                [disabled]="false">
                        </div>
                    </ng-template>

                </app-institutional-table>
            </div>

            <!-- Pagination -->
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="false"
                [showPaginationControls]="true" (pageChange)="onPageChange($event)">
            </app-table-pagination>
        </app-institutional-card>

    </form>

    <br>

    <!-- Footer Actions (Unwrapped) -->
    <div class="flex justify-end gap-3 mt-6">
        <app-institutional-button (buttonClick)="onCancel()"
            [config]="{variant: 'secondary', title: 'Cancelar', customClass: 'border-gray-300 text-gray-600'}">
            Cancelar
        </app-institutional-button>
        <app-institutional-button (buttonClick)="onSave()"
            [config]="{variant: 'primary', title: isEditMode ? 'Actualizar tipo de curso' : 'Guardar tipo de curso', customClass: '!bg-[#9D2449]', loading: isLoading, disabled: isLoading}">
            {{ isEditMode ? 'Actualizar Tipo de Curso' : 'Guardar Tipo de Curso' }}
        </app-institutional-button>
    </div>
</div>

<!-- Template Preview Modal -->
<app-template-preview-modal [isOpen]="showPreviewModal" [template]="previewTemplate" (close)="showPreviewModal = false">
</app-template-preview-modal>