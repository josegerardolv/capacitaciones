<div class="min-h-screen">
    <!-- Tarjeta superior: título y breadcrumb -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }"
        class="mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-institucional-primario bg-opacity-10 flex items-center justify-center">
                <app-universal-icon name="design_services" type="material"
                    class="w-6 h-6 text-white"></app-universal-icon>
            </div>

            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Formatos de Templates</h1>
                <p class="text-sm text-gray-500 mt-1">Gestiona los formatos reutilizables para los cursos</p>
            </div>
        </div>

        <div class="mt-2 ml-4">
            <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
    </app-institutional-card>

    <br>

    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }">
        <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-center gap-4 mb-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="true"
                [showPaginationControls]="false" (pageChange)="onPageChange($event)">
            </app-table-pagination>

            <div class="flex flex-col md:flex-row md:items-center gap-2">
                <app-institutional-button (buttonClick)="openCreateForm()" [config]="{
                    variant: 'primary',
                    icon: 'add'
                }">
                    Nuevo Template
                </app-institutional-button>
            </div>
        </div>

        <!-- Search Bar -->
        <app-table-filters [showGlobalSearch]="true" [globalSearchPlaceholder]="'Buscar por nombre, concepto...'"
            (globalSearchChange)="filterData($event)">
        </app-table-filters>

        <app-institutional-table [data]="templates" [columns]="tableColumns" [config]="tableConfig">
        </app-institutional-table>
        <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="false" [showPaginationControls]="true"
            (pageChange)="onPageChange($event)">
        </app-table-pagination>
    </app-institutional-card>
</div>

<!-- Modal unificado (crear / editar) -->
<app-modal-form *ngIf="(createModalOpen || editModalOpen) && form" [formGroup]="form"
    [isOpen]="createModalOpen || editModalOpen" [title]="editModalOpen ? 'Editar Template' : 'Nuevo Template'"
    [isLoading]="isSaving" (formSubmit)="editModalOpen ? onEditSubmit($event) : onCreateSubmit($event)"
    (modalClose)="closeModal()">

    <app-input-enhanced [control]="nameControl" label="Nombre" placeholder="Ingrese nombre" [required]="true">
    </app-input-enhanced>

    <div class="mb-4">
        <label class="flex items-center space-x-2 cursor-pointer mb-2">
            <input type="checkbox" [formControl]="isFreeControl" class="checkbox checkbox-primary checkbox-sm">
            <span class="text-sm font-medium text-gray-700">¿Es un trámite gratuito?</span>
        </label>

        <div *ngIf="!isFreeControl.value">
            <app-select [control]="conceptIdControl" [options]="conceptOptions" label="Concepto (Siox)"
                placeholder="Seleccione un concepto...">
            </app-select>
            <p class="text-xs text-gray-500 mt-1">Busque por nombre o clave del concepto.</p>
        </div>
        <div *ngIf="isFreeControl.value" class="p-3 bg-blue-50 text-blue-800 text-sm rounded-md border border-blue-100">
            Este template se marcará como <strong>Gratuito</strong> y no requerirá pago.
        </div>
    </div>

    <app-select [control]="tipoControl"
        [options]="[{ value: 'Participación', label: 'Participación' }, { value: 'Certificación', label: 'Certificación' }, { value: 'Reconocimiento', label: 'Reconocimiento' }, { value: 'Identificación', label: 'Identificación' }]"
        [size]="'md'" [placeholder]="'Seleccione Categoría'">
    </app-select>

    <app-input-enhanced [control]="descriptionControl" label="Descripción" placeholder="Descripción breve"
        type="textarea">
    </app-input-enhanced>

</app-modal-form>

<!-- Templates for Table -->
<ng-template #actionsTemplate let-item>
    <div class="flex items-center justify-center space-x-3">
        <app-institutional-button [config]="{ 
                variant: 'primary', 
                size: 'small', 
                icon: 'design_services', 
                iconPosition: 'only' }" [appTooltip]="'Editar diseño visual'" tooltipPosition="top"
            (buttonClick)="editTemplateDesign(item)">
        </app-institutional-button>
        <app-institutional-button [config]="{ variant: 'warning', size: 'small', icon: 'edit', iconPosition: 'only' }"
            [appTooltip]="'Editar información'" tooltipPosition="top" (buttonClick)="openEditForm(item)">
        </app-institutional-button>
        <app-institutional-button [config]="{ variant: 'danger', size: 'small', icon: 'delete', iconPosition: 'only' }"
            [appTooltip]="'Eliminar'" tooltipPosition="top" (buttonClick)="deleteTemplate(item)">
        </app-institutional-button>
    </div>
</ng-template>

<ng-template #conceptTemplate let-item>
    <div class="flex flex-col">
        <span class="font-medium text-gray-900">{{ item.conceptName || 'Sin concepto' }}</span>
        <span class="text-xs text-gray-500 font-mono">{{ item.conceptClave }}</span>
    </div>
</ng-template>

<ng-template #costTemplate let-item>
    <span *ngIf="item.conceptCosto > 0" class="font-medium">{{ item.conceptCosto | currency:'MXN' }}</span>
    <span *ngIf="item.conceptCosto === 0"
        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
        Gratuito
    </span>
</ng-template>

<ng-template #categoryTemplate let-item>
    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
        {{ item.category || 'General' }}
    </span>
</ng-template>


<!-- Modales Genéricos -->
<app-confirmation-modal [isOpen]="isConfirmOpen" [config]="confirmConfig" (confirm)="onConfirmYes()"
    (cancel)="isConfirmOpen = false" (modalClose)="isConfirmOpen = false">
</app-confirmation-modal>

<app-alert-modal [isOpen]="isAlertOpen" [config]="alertConfig" (actionClick)="isAlertOpen = false"
    (modalClose)="isAlertOpen = false">
</app-alert-modal>