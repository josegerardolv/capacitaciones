<div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true"
    *ngIf="isOpen">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true" (click)="close()">
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <!-- Modal panel -->
        <div
            class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:p-6">

            <!-- Header -->
            <div class="flex items-center justify-between mb-6 border-b border-gray-200 pb-4">
                <h3 class="text-xl font-bold leading-6 text-gob-wine" id="modal-title">
                    Constancias
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" (click)="close()">
                    <span class="sr-only">Cerrar</span>
                    <app-universal-icon name="close" [size]="24"></app-universal-icon>
                </button>
            </div>

            <!-- Body -->
            <div class="mb-6">
                <h4 class="text-lg font-medium text-gob-wine mb-4">Constancias Descargables</h4>

                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gob-wine text-white">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Template
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Descripción
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">
                                    Estatus Pago
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr *ngFor="let doc of documents">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {{ doc.name }}
                                    <span
                                        class="ml-2 text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full"
                                        *ngIf="doc.cost > 0">
                                        {{ doc.cost | currency }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    {{ doc.description }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                        [ngClass]="{
                                              'bg-gray-100 text-gray-500': doc.isLocked,
                                              'bg-blue-100 text-blue-800': !doc.isLocked && doc.cost === 0,
                                              'bg-green-100 text-green-800': !doc.isLocked && doc.cost > 0 && doc.isPaid,
                                              'bg-yellow-100 text-yellow-800': !doc.isLocked && doc.cost > 0 && !doc.isPaid
                                          }">
                                        {{ doc.isLocked ? 'Bloqueado' : (doc.cost === 0 ? 'Gratuito' : (doc.isPaid ?
                                        'Pagado' : 'Pendiente')) }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                    <div class="flex justify-center space-x-3">
                                        <!-- 1. Imprimir Orden de Pago -->
                                        <app-institutional-button *ngIf="doc.cost > 0" [config]="{
                                                variant: 'warning',
                                                size: 'small',
                                                icon: 'print',
                                                iconPosition: 'only',
                                                disabled: doc.isLocked
                                            }"
                                            [appTooltip]="doc.isLocked ? 'Debe cubrir los documentos obligatorios primero' : (doc.isPaid ? 'Reimprimir Orden de Pago' : 'Imprimir Orden de Pago')"
                                            tooltipPosition="top" (buttonClick)="printPaymentOrder(doc)">
                                        </app-institutional-button>

                                        <!-- 2. Descargar PDF -->
                                        <app-institutional-button [config]="{
                                                variant: 'success',
                                                size: 'small',
                                                icon: 'download',
                                                iconPosition: 'only',
                                                title: 'Descargar PDF',
                                                disabled: doc.isLocked || !doc.isPaid
                                            }"
                                            [appTooltip]="doc.isLocked ? 'Debe cubrir los documentos obligatorios primero' : (doc.isPaid ? 'Descargar PDF' : 'Requiere Pago')"
                                            tooltipPosition="top" (buttonClick)="downloadCertificate(doc)">
                                        </app-institutional-button>

                                        <!-- 3. Enviar por Correo -->
                                        <app-institutional-button [config]="{
                                                variant: 'info',
                                                size: 'small',
                                                icon: 'send',
                                                iconPosition: 'only',
                                                title: 'Enviar por Correo',
                                                disabled: doc.isLocked || !doc.isPaid
                                            }"
                                            [appTooltip]="doc.isLocked ? 'Debe cubrir los documentos obligatorios primero' : (doc.isPaid ? 'Enviar por Correo' : 'Requiere Pago')"
                                            tooltipPosition="top" (buttonClick)="emailCertificate(doc)">
                                        </app-institutional-button>
                                    </div>
                                </td>
                            </tr>
                            <tr *ngIf="documents.length === 0">
                                <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500 italic">
                                    No hay constancias disponibles para esta persona.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <div class="col-start-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta para Opciones de Envío -->
    <app-alert-modal [isOpen]="isAlertOpen" [config]="alertConfig" (actionClick)="isAlertOpen = false"
        (modalClose)="isAlertOpen = false">
    </app-alert-modal>
</div>