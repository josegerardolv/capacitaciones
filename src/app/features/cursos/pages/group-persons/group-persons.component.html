<div class="min-h-screen">

    <!-- Tarjeta superior: título y breadcrumb -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }"
        class="mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-institucional-primario bg-opacity-10 flex items-center justify-center">
                <app-universal-icon name="person_text" type="material" class="w-6 h-6 text-white"></app-universal-icon>
            </div>

            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Personas inscritas {{ 'al grupo ' +
                    (this.groupLabel ? (this.groupLabel || 'id' + this.groupId) : '')}}</h1>
                <p class="text-sm text-gray-500 mt-1">Gestiona las personas del grupo</p>
            </div>
        </div>

        <div class="mt-2 ml-4">
            <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
    </app-institutional-card>
    <br>

    <!-- Tarjeta inferior: acciones, tabla y paginación -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }">
        <!-- Toolbar: paginación superior y botón crear -->
        <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-center gap-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="true"
                [showPaginationControls]="false" (pageChange)="onPageChange($event)">
            </app-table-pagination>

            <div class="flex flex-col md:flex-row md:items-center gap-2">
                <app-institutional-button (buttonClick)="openNewDriverForm()" [config]="{
                    variant: 'primary',
                    icon: 'add'
                }">
                    Nueva Persona
                </app-institutional-button>
            </div>
        </div>

        <!-- Tabla -->
        <app-institutional-table [data]="drivers" [columns]="tableColumns" [config]="tableConfig">
        </app-institutional-table>

        <!-- Paginación inferior -->
        <div class="mt-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="false"
                [showPaginationControls]="true" (pageChange)="onPageChange($event)">
            </app-table-pagination>
        </div>

    </app-institutional-card>

    <!-- MODAL DE BÚSQUEDA (NUEVO) -->
    <div *ngIf="isSearchModalOpen"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl overflow-hidden transform transition-all mx-4">
            <!-- Header -->
            <div class="bg-institucional-primario text-white px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-bold">Registrar Persona</h3>
                <button (click)="closeSearchModal()" class="text-white hover:text-gray-200 transition-colors">
                    <app-universal-icon name="close" type="material" class="w-6 h-6 text-white"></app-universal-icon>
                </button>
            </div>

            <!-- Body -->
            <div class="p-12 flex flex-col items-center justify-center min-h-[400px]">
                <div class="w-full max-w-2xl flex flex-col gap-8">

                    <div class="flex items-end gap-4 w-full">
                        <!-- Input Licencia -->
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ingresa el número de
                                licencia</label>
                            <input type="text" [(ngModel)]="searchLicense" (keyup.enter)="searchDriver()"
                                placeholder="Ej. H67PPP000040052"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional-primario focus:border-institucional-primario text-lg uppercase"
                                [disabled]="isSearching">
                        </div>

                        <!-- Botón Buscar -->
                        <div class="mb-[2px]"> <!-- Ajuste visual para alinear con input -->
                            <app-institutional-button (buttonClick)="searchDriver()" [config]="{
                                variant: 'primary',
                                icon: 'search',
                                loading: isSearching
                            }">
                                Buscar
                            </app-institutional-button>
                        </div>
                    </div>

                    <!-- Mensaje de ayuda o estado -->
                    <div class="text-center text-gray-500 text-sm">
                        <p *ngIf="!isSearching">Presiona Enter o haz clic en Buscar</p>
                        <p *ngIf="isSearching"
                            class="text-institucional-primario font-semibold flex items-center justify-center gap-2">
                            <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-current"></span> Buscando
                            en el padrón...
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <!-- Estatus: Badge Aprobado/No Aprobado o Botones de Calificación -->
    <ng-template #statusTemplate let-item>
        <!-- Estado ya calificado: usar badge institucional -->
        <ng-container *ngIf="item.status !== 'Pendiente'">
            <app-institutional-badge
                [config]="{ variant: item.status === 'Aprobado' ? 'success' : 'danger', size: 'small' }">
                {{ item.status }}
            </app-institutional-badge>
        </ng-container>

        <!-- Pendiente: acciones de calificación con botones institucionales -->
        <div *ngIf="item.status === 'Pendiente'" class="flex items-center justify-center gap-2">
            <app-institutional-button
                [config]="{ variant: 'success', icon: 'check', iconPosition: 'only', size: 'small' }"
                (buttonClick)="setExamResult(item, 'Aprobado')" [appTooltip]="'Aprobar Examen'" tooltipPosition="top">
            </app-institutional-button>

            <app-institutional-button
                [config]="{ variant: 'danger', icon: 'close', iconPosition: 'only', size: 'small' }"
                (buttonClick)="setExamResult(item, 'No Aprobado')" [appTooltip]="'Reprobar Examen'"
                tooltipPosition="top">
            </app-institutional-button>
        </div>
    </ng-template>
    <!-- Acciones: Botones circulares de colores -->
    <ng-template #actionsTemplate let-item>
        <div class="flex items-center justify-center gap-2">
            <!-- Constancia (Verde/Naranja) -->
            <app-institutional-button [config]="{
                    variant: item.coursePaymentStatus === 'Pagado' ? 'success' : 'warning',
                    icon: 'description',
                    iconPosition: 'only',
                    disabled: item.status !== 'Aprobado',
                }" (buttonClick)="item.status === 'Aprobado' && viewCertificate(item)"
                [appTooltip]="item.status === 'Aprobado' ? (item.coursePaymentStatus === 'Pagado' ? 'Descargar Constancia' : 'Pago Curso Pendiente') : 'Requiere Aprobación'"
                tooltipPosition="top">
            </app-institutional-button>

            <!-- Tarjetón (Verde/Ambar/Azul) -->
            <app-institutional-button [config]="{
                    variant: item.paymentStatus === 'Pagado' ? 'success' : (item.paymentStatus === 'Pendiente' ? 'warning' : 'info'),
                    icon: 'badge',
                    iconPosition: 'only',
                    disabled: item.status !== 'Aprobado',
                }" (buttonClick)="item.status === 'Aprobado' && requestTarjeton(item)"
                [appTooltip]="item.status === 'Aprobado' ? (item.paymentStatus === 'Pagado' ? 'Descargar Tarjetón' : (item.paymentStatus === 'Pendiente' ? 'Pago Pendiente' : 'Generar Tarjetón')) : 'Requiere Aprobación'"
                tooltipPosition="top">
            </app-institutional-button>

            <!-- Eliminar (Rojo) -->
            <app-institutional-button [config]="{
                    variant: 'danger',
                    icon: 'delete',
                    iconPosition: 'only',
                }" (buttonClick)="deleteDriver(item)" [appTooltip]="'Eliminar Conductor'" tooltipPosition="top">
            </app-institutional-button>
        </div>
    </ng-template>

    <!-- Modales Genéricos -->
    <app-confirmation-modal [isOpen]="isConfirmOpen" [config]="confirmConfig" (confirm)="onConfirmYes()"
        (cancel)="isConfirmOpen = false" (modalClose)="isConfirmOpen = false">
    </app-confirmation-modal>

    <app-alert-modal [isOpen]="isAlertOpen" [config]="alertConfig" (actionClick)="isAlertOpen = false"
        (modalClose)="isAlertOpen = false">
    </app-alert-modal>
</div>