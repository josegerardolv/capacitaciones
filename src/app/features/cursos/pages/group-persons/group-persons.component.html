<div class="min-h-screen">

    <!-- Tarjeta superior: título y breadcrumb -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }"
        class="mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-institucional-primario bg-opacity-10 flex items-center justify-center">
                <app-universal-icon name="person_text" type="material" class="w-6 h-6 text-white"></app-universal-icon>
            </div>

            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Personas inscritas {{ 'al grupo ' +
                    (this.groupLabel ? (this.groupLabel || 'id' + this.groupId) : '')}}</h1>
                <p class="text-sm text-gray-500 mt-1">Gestiona las personas del grupo</p>
            </div>
        </div>

        <div class="mt-2 ml-4">
            <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
    </app-institutional-card>
    <br>

    <!-- Tarjeta inferior: acciones, tabla y paginación -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }">
        <!-- Toolbar: paginación superior y botón crear -->
        <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-center gap-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="true"
                [showPaginationControls]="false" (pageChange)="onPageChange($event)">
            </app-table-pagination>

            <app-institutional-button (buttonClick)="openNewPersonForm()" [config]="{
                    variant: 'primary',
                    icon: 'add'
                }">
                Nueva Persona
            </app-institutional-button>
        </div>

        <!-- Search Bar -->
        <div class="relative w-full md:w-96 mb-6">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="material-symbols-outlined text-gray-400">search</span>
            </div>
            <input [formControl]="searchControl" type="text" placeholder="Buscar por nombre, licencia, CURP..."
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-institucional-primario focus:border-institucional-primario sm:text-sm transition duration-150 ease-in-out"
                autocomplete="off">
        </div>

        <!-- Tabla -->
        <app-institutional-table [data]="persons" [columns]="tableColumns" [config]="tableConfig">
        </app-institutional-table>

        <!-- Paginación inferior -->
        <div class="mt-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="false"
                [showPaginationControls]="true" (pageChange)="onPageChange($event)">
            </app-table-pagination>
        </div>

    </app-institutional-card>

    <!-- MODAL DE BÚSQUEDA (NUEVO REUTILIZABLE) -->
    <app-license-search-modal [isOpen]="isSearchModalOpen" (modalClose)="isSearchModalOpen = false"
        (personFound)="onPersonFound($event)" (manualRegistration)="onManualRegistration($event)">
    </app-license-search-modal>

    <!-- Templates -->
    <!-- Nombre Completo: Combina Nombre + Apellidos -->
    <ng-template #nameTemplate let-item>
        <div class="flex flex-col">
            <span class="font-bold text-gray-900">{{ item.name }} {{ item.firstSurname }} {{ item.secondSurname
                }}</span>
        </div>
    </ng-template>

    <!-- Estatus: Badge Aprobado/No Aprobado o Botones de Calificación -->
    <ng-template #statusTemplate let-item>
        <!-- Estado ya calificado: usar badge institucional -->
        <ng-container *ngIf="item.status !== 'Pendiente'">
            <app-institutional-badge
                [config]="{ variant: item.status === 'Aprobado' ? 'success' : 'danger', size: 'small' }">
                {{ item.status }}
            </app-institutional-badge>
        </ng-container>

        <!-- Pendiente: acciones de calificación con botones institucionales -->
        <div *ngIf="item.status === 'Pendiente'" class="flex items-center justify-center gap-2">
            <app-institutional-button
                [config]="{ variant: 'success', icon: 'check', iconPosition: 'only', size: 'small' }"
                (buttonClick)="setExamResult(item, 'Aprobado')" [appTooltip]="'Aprobar Examen'" tooltipPosition="top">
            </app-institutional-button>

            <app-institutional-button
                [config]="{ variant: 'danger', icon: 'close', iconPosition: 'only', size: 'small' }"
                (buttonClick)="setExamResult(item, 'No Aprobado')" [appTooltip]="'Reprobar Examen'"
                tooltipPosition="top">
            </app-institutional-button>
        </div>
    </ng-template>
    <!-- Acciones: Botones circulares de colores -->
    <ng-template #actionsTemplate let-item>
        <div class="flex items-center justify-center gap-2">
            <!-- Constancia (Verde/Naranja) -->
            <app-institutional-button [config]="{
                    variant: item.coursePaymentStatus === 'Pagado' ? 'success' : 'warning',
                    icon: 'description',
                    iconPosition: 'only',
                    disabled: item.status !== 'Aprobado',
                }" (buttonClick)="item.status === 'Aprobado' && viewCertificate(item)"
                [appTooltip]="item.status === 'Aprobado' ? (item.coursePaymentStatus === 'Pagado' ? 'Descargar Constancia' : 'Pago Curso Pendiente') : 'Requiere Aprobación'"
                tooltipPosition="top">
            </app-institutional-button>

            <!-- Tarjetón (Verde/Ambar/Azul) -->
            <app-institutional-button [config]="{
                    variant: item.paymentStatus === 'Pagado' ? 'success' : (item.paymentStatus === 'Pendiente' ? 'warning' : 'info'),
                    icon: 'badge',
                    iconPosition: 'only',
                    disabled: item.status !== 'Aprobado',
                }" (buttonClick)="item.status === 'Aprobado' && requestTarjeton(item)"
                [appTooltip]="item.status === 'Aprobado' ? (item.paymentStatus === 'Pagado' ? 'Descargar Tarjetón' : (item.paymentStatus === 'Pendiente' ? 'Pago Pendiente' : 'Generar Tarjetón')) : 'Requiere Aprobación'"
                tooltipPosition="top">
            </app-institutional-button>

            <!-- Eliminar (Rojo) -->
            <app-institutional-button [config]="{
                    variant: 'danger',
                    icon: 'delete',
                    iconPosition: 'only',
                }" (buttonClick)="deletePerson(item)" [appTooltip]="'Eliminar Persona'" tooltipPosition="top">
            </app-institutional-button>
        </div>
    </ng-template>

    <!-- Modales Genéricos -->
    <app-confirmation-modal [isOpen]="isConfirmOpen" [config]="confirmConfig" (confirm)="onConfirmYes()"
        (cancel)="isConfirmOpen = false" (modalClose)="isConfirmOpen = false">
    </app-confirmation-modal>

    <app-alert-modal [isOpen]="isAlertOpen" [config]="alertConfig" (actionClick)="isAlertOpen = false"
        (modalClose)="isAlertOpen = false">
    </app-alert-modal>

    <!-- Modal de Selección de Documentos -->
    <app-document-selection-modal [isOpen]="isDocumentsModalOpen" [courseType]="currentGroup?.courseType || 'LICENCIA'"
        (modalClose)="closeDocumentsModal()" (confirm)="onDocumentsConfirmed($event)">
    </app-document-selection-modal>
</div>