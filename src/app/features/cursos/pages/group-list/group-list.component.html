<div class="min-h-screen">

    <!-- Tarjeta superior: título y breadcrumb -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }"
        class="mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-institucional-primario bg-opacity-10 flex items-center justify-center">
                <app-universal-icon name="groups" type="material" class="w-6 h-6 text-white"></app-universal-icon>
            </div>

            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Grupos {{ 'del curso ' + (this.courseLabel
                    ? (this.courseLabel || 'id' + this.cursoId) : '')}}</h1>
                <p class="text-sm text-gray-500 mt-1">Gestiona los grupos asociados al curso seleccionado</p>
            </div>
        </div>

        <div class="mt-2 ml-4">
            <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
    </app-institutional-card>
    <br>
    <!-- Tarjeta inferior: acciones, tabla y paginación -->
    <app-institutional-card [config]="{ showHeader: false, showFooter: false, showShadow: true, showBorder: true }">
        <!-- Toolbar: paginación superior y botón crear -->
        <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-center gap-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="true"
                [showPaginationControls]="false" (pageChange)="onPageChange($event)">
            </app-table-pagination>

            <div class="flex flex-col md:flex-row md:items-center gap-2">
                <app-institutional-button (buttonClick)="exportData()" [config]="{
                    variant: 'secondary',
                    icon: 'download',
                    title: 'Exportar',
                    disabled: !canExport
                }">
                    Exportar
                </app-institutional-button>

                <app-institutional-button (buttonClick)="generateUrl()" [config]="{
                    variant: 'secondary',
                    icon: 'link',
                    title: 'Generar URL',
                    disabled: !canGenerateUrl
                }">
                    Generar URL {{ selectedGroups.length > 0 ? '(' + selectedGroups.length + ')' : '' }}
                </app-institutional-button>

                <app-institutional-button (buttonClick)="openForm()" [config]="{
                    variant: 'primary',
                    icon: 'add',
                    title: 'Nuevo Grupo'
                }">
                    Nuevo Grupo
                </app-institutional-button>
            </div>
        </div>

        <!-- Barra de Búsqueda -->
        <app-table-filters [showGlobalSearch]="true" [globalSearchPlaceholder]="'Buscar grupo por nombre, ubicación...'"
            (globalSearchChange)="filterData($event)">
        </app-table-filters>

        <!-- Tabla -->
        <app-institutional-table [data]="groups" [columns]="tableColumns" [config]="tableConfig"
            [selectedItems]="selectedGroups" (selectionChange)="onSelectionChange($event)">
        </app-institutional-table>

        <!-- Paginación inferior -->
        <div class="mt-4">
            <app-table-pagination [config]="paginationConfig" [showPageSizeSelector]="false"
                [showPaginationControls]="true" (pageChange)="onPageChange($event)">
            </app-table-pagination>
        </div>

    </app-institutional-card>
</div>

<app-modal-form [isOpen]="showModal" [title]="modalMode === 'create' ? 'Nuevo Grupo' : 'Editar Grupo'"
    (modalClose)="closeModal()" (formSubmit)="onGroupModalSubmit()" [formGroup]="groupModalForm" [isLoading]="isSaving"
    [size]="'xl'">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Fila 1 -->
        <div class="col-span-1">
            <app-input-enhanced controlName="name" [control]="groupModalForm.get('name')" label="Nombre del grupo"
                placeholder="Ingresa el nombre del grupo" [required]="true">
            </app-input-enhanced>
        </div>

        <div class="col-span-1">
            <app-input-enhanced controlName="location" [control]="groupModalForm.get('location')" label="Ubicación"
                placeholder="Ingresa la ubicación" [required]="true">
            </app-input-enhanced>
        </div>

        <!-- Fila 2 -->
        <div class="col-span-1">
            <app-input-enhanced type="date" controlName="date" [control]="groupModalForm.get('date')"
                label="Fecha de inicio curso" placeholder="Selecciona la fecha" [required]="true"
                [min]="minDateForForm">
            </app-input-enhanced>
        </div>

        <div class="col-span-1">
            <app-input-enhanced type="time" controlName="time" [control]="groupModalForm.get('time')"
                label="Hora de inicio" placeholder="Selecciona la hora" [required]="true">
            </app-input-enhanced>
        </div>

        <div class="col-span-1">
            <app-input-enhanced type="number" controlName="limitStudents" [control]="groupModalForm.get('limitStudents')"
                label="Cantidad máxima de personas" placeholder="Ingresa la cantidad máxima de personas"
                [required]="true">
            </app-input-enhanced>
        </div>

        <div class="col-span-1">
            <app-input-enhanced type="date" controlName="linkExpiration"
                [control]="groupModalForm.get('linkExpiration')" label="Límite de auto-registro (Opcional)"
                placeholder="Selecciona fecha límite" [required]="false" [max]="maxDateForForm" [min]="minDateForForm"
                [extraClasses]="'bg-blue-50 border-blue-200 text-blue-800 font-medium'">
            </app-input-enhanced>
        </div>

        <!-- Error de Validación de Fechas -->
        <div class="col-span-1 md:col-span-3"
            *ngIf="groupModalForm.errors?.['dateError'] && (groupModalForm.touched || groupModalForm.dirty)">
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <app-universal-icon name="error_outline" class="h-5 w-5 text-red-400"></app-universal-icon>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700 font-medium">
                            {{ groupModalForm.errors?.['dateError'] }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</app-modal-form>

<app-group-requests [isOpen]="isRequestsModalOpen" [group]="selectedRequestGroup" (close)="isRequestsModalOpen = false">
</app-group-requests>

<!-- Plantillas para columnas -->
<ng-template #urlTemplate let-item>
    <div class="flex items-center justify-center">
        <button *ngIf="item.inscriptionURL" (click)="copyUrl(item.inscriptionURL)"
            class="text-gray-500 hover:text-gray-700 transition-colors p-1 rounded-full hover:bg-gray-100"
            title="Copiar enlace">
            <app-universal-icon name="link" type="material" class="w-5 h-5"></app-universal-icon>
        </button>
        <span *ngIf="!item.inscriptionURL" class="text-xs text-gray-400 italic">Sin enlace</span>
    </div>
</ng-template>

<ng-template #statusTemplate let-item>
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" [ngClass]="{
            'bg-green-100 text-green-800': item.status === 'Activo',
            'bg-gray-100 text-gray-800': item.status === 'Inactivo'
          }">
        <span class="w-2 h-2 mr-1 rounded-full" [ngClass]="{
                'bg-green-400': item.status === 'Activo',
                'bg-gray-400': item.status === 'Inactivo'
              }"></span>
        {{ item.status }}
    </span>
</ng-template>

<!-- Plantillas para Selección y Fecha/Hora -->

<ng-template #dateTemplate let-item>
    <span class="text-gray-900">{{ formatDateForDisplay(item.groupStartDate) }}</span>
</ng-template>

<ng-template #expirationDateTemplate let-item>
    <span class="text-gray-900" *ngIf="item.endInscriptionDate">{{ formatDateForDisplay(item.endInscriptionDate)
        }}</span>
    <span class="text-gray-400 italic text-xs" *ngIf="!item.endInscriptionDate">Sin límite</span>
</ng-template>

<ng-template #timeTemplate let-item>
    <span class="text-gray-500">{{ item.schedule }}</span>
</ng-template>

<!-- Plantilla para Acciones -->
<ng-template #actionsTemplate let-item>
    <div class="flex items-center justify-center space-x-3">
        <app-institutional-button [config]="{
                variant: 'info',
                size: 'small', 
                icon: 'list_alt',
                title: 'Ver detalles',
                iconPosition: 'only'}" [appTooltip]="'Ver detalles'" tooltipPosition="top"
            (buttonClick)="viewPersons(item)">
        </app-institutional-button>
        <div class="relative">
            <app-institutional-button [config]="{
                variant: 'secondary',
                size: 'small', 
                icon: 'patient_list',
                title: 'Solicitudes pendientes',
                iconPosition: 'only'}" [appTooltip]="'Solicitudes pendientes'" tooltipPosition="top"
                (buttonClick)="openRequests(item)">
            </app-institutional-button>
            <span *ngIf="item.requests > 0"
                class="absolute -top-2 -right-2 inline-flex items-center justify-center bg-red-600 text-white text-xs font-semibold rounded-full px-2 py-0.5">{{
                item.requests }}</span>
        </div>
        <app-institutional-button [config]="{
                variant: 'warning',
                size: 'small', 
                icon: 'edit',
                title: 'Editar',
                iconPosition: 'only'}" [appTooltip]="'Editar'" tooltipPosition="top"
            (buttonClick)="openEditForm(item)">
        </app-institutional-button>
        <app-institutional-button [config]="{
                variant: 'danger',
                size: 'small', 
                icon: 'delete',
                title: 'Eliminar',
                iconPosition: 'only'}" [appTooltip]="'Eliminar'" tooltipPosition="top"
            (buttonClick)="deleteGroup(item.id)">
        </app-institutional-button>
    </div>
</ng-template>

<!-- Modales Genéricos -->
<app-confirmation-modal [isOpen]="isConfirmOpen" [config]="confirmConfig" (confirm)="onConfirmYes()"
    (cancel)="isConfirmOpen = false" (modalClose)="isConfirmOpen = false">
</app-confirmation-modal>
<app-alert-modal [isOpen]="isAlertOpen" [config]="alertConfig" (actionClick)="isAlertOpen = false"
    (modalClose)="isAlertOpen = false">
</app-alert-modal>

<!-- Modal para pedir fecha de expiración si falta -->
<app-modal-form [isOpen]="isUrlDateModalOpen" title="Definir Límite de Auto-registro"
    (modalClose)="isUrlDateModalOpen = false" (formSubmit)="submitUrlGeneration()" [size]="'md'"
    [primaryActions]="urlModalActions" [formGroup]="urlForm">
    <div class="space-y-4">
        <div class="bg-blue-50 p-4 rounded-md mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <app-universal-icon name="info" class="h-5 w-5 text-blue-400"></app-universal-icon>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        El grupo seleccionado no tiene fecha límite. Defínela para continuar.
                    </p>
                </div>
            </div>
        </div>

        <app-input-enhanced type="date" controlName="expirationDate" label="Fecha Límite de Registro *"
            placeholder="Selecciona la fecha límite" [required]="true" [max]="maxDateForUrl" [min]="minDateForForm"
            [extraClasses]="'bg-blue-50 border-blue-200 text-blue-800 font-medium'">
        </app-input-enhanced>
        <p class="text-xs text-gray-500 mt-1" *ngIf="maxDateForUrl">
            Debe ser antes del inicio del curso ({{ formatDateForTable(maxDateForUrl) }})
        </p>
    </div>
</app-modal-form>